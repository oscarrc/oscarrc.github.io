---
import { parseISO, getYear } from 'date-fns'
import { range } from '@/utils/array'
import { fetchActivityData, groupByWeeks, groupByMonths } from '@/utils/github'

interface Props {
  username: string
  year?: number
}

const contributionClasses = [
  'bg-base-300',
  'bg-primary/25',
  'bg-primary/50',
  'bg-primary/75',
  'bg-primary/100'
]

const { username, year = 'last' } = Astro.props

const data = await fetchActivityData(username, year);

const totalCount = year === 'last' ? data.total.lastYear : data.total[year]
const maxLevel = 4
const hideColorLegend = false
const hideTotalCount = false
const weekStart = 0

const activities = data.contributions
const firstActivity = activities[0]
const activityYear = getYear(parseISO(firstActivity.date))
const weeks = groupByWeeks(activities, weekStart);
const months = groupByMonths(weeks);

const labels = {
  totalCount: `{{count}} contributions in ${year === 'last' ? 'the last year' : '{{year}}'}`,
  legend: {
    less: 'Less',
    more: 'More',
  },
}
---

<article
  id="github-activity-calendar"
  class="w-full max-w-full flex flex-col gap-4 text-sm"
>
  <div class="w-full overflow-x-auto py-2">
    <div class="flex gap-2 min-w-max">
      {months.map(({ month, weeks }) => (
        <div class="flex flex-col gap-2 w-fit">
          <!-- Month Label -->
          <h3 class="text-sm font-medium text-base-content/80 text-center truncate max-w-full">
            {month}
          </h3>
          
          <div class="flex gap-1 justify-end">
            {weeks.map((week) => (
              <div class="flex flex-col gap-1">
                {week.map((activity) => {
                  if (!activity) {
                    return (
                      <div 
                        class="w-3 h-3 rounded-sm bg-base-300"
                        title="No data"
                      ></div>
                    )
                  }
                  return (
                    <div
                      class={`w-3 h-3 rounded-sm transition-all duration-200 hover:scale-110 cursor-pointer border border-base-content/10 hover:border-base-content/20 ${contributionClasses[activity.level] || 'bg-base-300'}`}
                      title={`${activity.count} contributions on ${activity.date}`}
                      data-date={activity.date}
                      data-level={activity.level}
                      data-count={activity.count}
                    ></div>
                  )
                })}
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>
  </div>

  <!-- Footer with stats and legend -->
  {
    !(hideTotalCount && hideColorLegend) && (
      <footer class="flex flex-col sm:flex-row sm:justify-between gap-4">
        {!hideTotalCount && (
          <div class="text-sm text-base-content/70">
            {labels.totalCount
              ? labels.totalCount
                  .replace('{{count}}', String(totalCount))
                  .replace('{{year}}', String(activityYear))
              : `${totalCount} activities in ${activityYear}`}
          </div>
        )}
        {!hideColorLegend && (
          <div class="flex items-center gap-1">
            <span class="text-xs text-base-content/70 mr-2">{labels.legend.less}</span>
            {range(maxLevel + 1).map((level) => (
              <div 
                class={`h-3 w-3 rounded-sm ${contributionClasses[level] || 'bg-base-300'}`}
                title={`Level ${level}`}
              ></div>
            ))}
            <span class="text-xs text-base-content/70 ml-2">{labels.legend.more}</span>
          </div>
        )}
      </footer>
    )
  }
</article>