---
import { Image } from "astro:assets";
import Dialog from "./Dialog.astro";
import Icon from "./Icon.astro";
import avatar from "@/assets/avatar.png";
---

<Dialog id="chat">
    <div class="flex flex-col h-[600px]" x-data="chatDialog">
    <!-- Chat Messages Container -->
    <div 
      id="chat-messages" 
      class="flex-1 overflow-y-auto p-4 space-y-4"
      x-ref="messagesContainer"
    >
      <template x-for="message in messages" :key="message.id">
        <div :class="message.role === 'user' ? 'chat chat-end' : 'chat chat-start'">
          <template x-if="message.role === 'assistant'">
            <div class="chat-image avatar">
              <div class="w-10 rounded-full  bg-base-200">
                <Image src={avatar} alt="Assistant Avatar" />
              </div>
            </div> 
          </template>
          <div class="chat-bubble text-sm" :class="message.role === 'user' ? 'chat-bubble-primary' : 'chat-bubble-base-200'">
            <template x-if="message.isLoading">
              <p class="text-sm text-base-content/60">
                <span class="loading loading-dots loading-xs"></span>
              </p>
            </template>
            <template x-if="!message.isLoading">
              <p class="text-sm whitespace-pre-line" x-text="message.content"></p>
            </template>
          </div>
        </div>
      </template>
    </div>

    <!-- Input Bar at Bottom -->
    <div class="px-4">
      <form id="chat-form" @submit.prevent="sendMessage" class="relative">
        <div class="relative">
          <textarea
            id="chat-input"
            x-model="inputMessage"
            @input="resizeTextarea($el)"
            @keydown.enter.exact.prevent="sendMessage()"
            @keydown.enter.shift.exact.prevent="inputMessage += '\n'"
            class="textarea textarea-bordered w-full pr-12 resize-none min-h-[2.5rem] max-h-32 text-sm"
            placeholder="Ask me anything..."
            rows="1"
            x-ref="textarea"
          ></textarea>
          <button
            type="submit"
            class="btn btn-primary btn-sm btn-square absolute bottom-2 right-4"
            :disabled="!inputMessage.trim() || isLoading || !isWorkerReady"
          >
            <Icon name="send" class="text-lg" />
          </button>
        </div>
      </form>
    </div>
  </div>
</Dialog>

<script>
  import Alpine from "alpinejs";

  const modal = document.getElementById("chat") as HTMLDialogElement | null;
  const chatInput = document.getElementById("chat-input") as HTMLTextAreaElement | null;

  Alpine.data("chatDialog", () => ({
    inputMessage: "",
    isLoading: false,
    isWorkerReady: false,
    worker: null as Worker | null,
    pendingRequestId: null as string | null,
    pendingAnswerIndex: null as number | null,
    nextMessageId: 2,
    messages: [
      {
        id: 1,
        role: "assistant",
        content: "Hello! Ask me anything about my portfolio content.",
        isLoading: false,
      },
    ],
    resizeTextarea(textarea: HTMLTextAreaElement) {
      textarea.style.height = "auto";
      textarea.style.height = `${Math.min(textarea.scrollHeight, 128)}px`;
    },
    scrollToBottom() {
      this.$nextTick(() => {
        if (this.$refs.messagesContainer) {
          this.$refs.messagesContainer.scrollTop = this.$refs.messagesContainer.scrollHeight;
        }
      });
    },
    appendMessage(role: "user" | "assistant", content: string, isLoading = false) {
      const message = { id: this.nextMessageId++, role, content, isLoading };
      this.messages.push(message);
      this.scrollToBottom();
      return this.messages.length - 1;
    },
    setupWorker() {
      if (this.worker) return;
      try {
        const worker = new Worker(new URL("../workers/ai.ts", import.meta.url), { type: "module" });
        worker.onmessage = (event: MessageEvent<any>) => this.handleWorkerMessage(event);
        worker.onerror = (error) => {
          console.error("Worker error", error);
          this.isWorkerReady = false;
          this.isLoading = false;
          this.appendMessage(
            "assistant",
            "I ran into an error while getting ready. Please refresh the page and try again."
          );
        };
        worker.postMessage({ type: "init" });
        this.worker = worker;
      } catch (error) {
        console.error("Failed to start AI worker", error);
        this.appendMessage(
          "assistant",
          "I couldn't start my AI helper. Please try reloading the page."
        );
      }
    },
    handleWorkerMessage(event: MessageEvent<any>) {
      const data = event.data;
      if (!data) return;

      if (data.type === "ready") {
        this.isWorkerReady = true;
        return;
      }

      if (!this.pendingRequestId || data.id !== this.pendingRequestId) {
        return;
      }

      switch (data.type) {
        case "status": {
          if (this.pendingAnswerIndex !== null) {
            const pendingMessage = this.messages[this.pendingAnswerIndex];
            pendingMessage.content = "";
            pendingMessage.isLoading = true;
            this.scrollToBottom();
          }
          break;
        }
        case "result": {
          if (this.pendingAnswerIndex !== null) {
            const pendingMessage = this.messages[this.pendingAnswerIndex];
            pendingMessage.content = data.answer;
            pendingMessage.isLoading = false;
            this.scrollToBottom();
          } else {
            this.appendMessage("assistant", data.answer);
          }
          this.isLoading = false;
          this.pendingRequestId = null;
          this.pendingAnswerIndex = null;
          break;
        }
        case "error": {
          const fallback =
            data.error || "Sorry, I couldn't answer that right now. Please try again later.";
          if (this.pendingAnswerIndex !== null) {
            const pendingMessage = this.messages[this.pendingAnswerIndex];
            pendingMessage.content = fallback;
            pendingMessage.isLoading = false;
            this.scrollToBottom();
          } else {
            this.appendMessage("assistant", fallback);
          }
          this.isLoading = false;
          this.pendingRequestId = null;
          this.pendingAnswerIndex = null;
          break;
        }
        default:
          console.warn("Unhandled worker message", data);
      }
    },
    sendMessage() {
      if (!this.inputMessage.trim() || this.isLoading) return;

      const userMessage = this.inputMessage.trim();
      this.appendMessage("user", userMessage);
      this.inputMessage = "";

      if (this.$refs.textarea) {
        this.$refs.textarea.style.height = "auto";
      }

      if (!this.worker || !this.isWorkerReady) {
        this.appendMessage(
          "assistant",
          "Iâ€™m still getting ready. Please wait a moment and try again."
        );
        return;
      }

      const requestId = crypto.randomUUID
        ? crypto.randomUUID()
        : `${Date.now()}-${Math.random().toString(16).slice(2)}`;

      this.isLoading = true;
      this.pendingRequestId = requestId;
      this.pendingAnswerIndex = this.appendMessage(
        "assistant",
        "",
        true
      );

      this.worker.postMessage({ type: "ask", id: requestId, question: userMessage });
    },
    init() {
      this.setupWorker();
      this.scrollToBottom();
      window.addEventListener("beforeunload", () => {
        this.worker?.terminate();
      });
    },
  }));

  document.addEventListener("keydown", (event) => {
    if (event.ctrlKey && event.key === "a") {
      event.preventDefault();
      modal?.showModal();
      chatInput?.focus();
    }
  });

  document.getElementById("chat-input")?.addEventListener("keydown", (event) => {
    if(event.key === "Enter" && !event.ctrlKey) {
      event.preventDefault();
      document.getElementById("chat-form")?.dispatchEvent(new Event("submit", { cancelable: true, bubbles: true }));
    }

    if(event.key === "Enter" && event.ctrlKey) {
      const textarea = event.target as HTMLTextAreaElement;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      textarea.value = textarea.value.substring(0, start) + "\n" + textarea.value.substring(end);
      textarea.selectionStart = textarea.selectionEnd = start + 1;
      event.preventDefault();
    }
  });
</script>

