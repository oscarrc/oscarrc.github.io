---
import Dialog from "./Dialog.astro";
import Icon from "./Icon.astro";
---

<Dialog id="chat">
  <div class="flex flex-col h-[600px]" x-data="chatDialog">
    <!-- Chat Messages Container -->
    <div 
      id="chat-messages" 
      class="flex-1 overflow-y-auto p-4 space-y-4"
      x-ref="messagesContainer"
    >
      <template x-for="message in messages" :key="message.id">
        <div :class="message.role === 'user' ? 'chat chat-end' : 'chat chat-start'">
          <div class="chat-bubble text-sm" :class="message.role === 'user' ? 'chat-bubble-primary' : 'chat-bubble-base-200'">
            <span class="text-sm" x-html="message.content"></span>
          </div>
        </div>
      </template>
    </div>

    <!-- Input Bar at Bottom -->
    <div class="px-4">
      <form @submit.prevent="sendMessage" class="relative">
        <div class="relative">
          <textarea
            id="chat-input"
            x-model="inputMessage"
            @input="resizeTextarea($el)"
            @keydown.enter.exact.prevent="sendMessage()"
            @keydown.enter.shift.exact.prevent="inputMessage += '\n'"
            class="textarea textarea-bordered w-full pr-12 resize-none min-h-[2.5rem] max-h-32 text-sm"
            placeholder="Ask me anything..."
            rows="1"
            x-ref="textarea"
          ></textarea>
          <button
            type="submit"
            class="btn btn-primary btn-sm absolute bottom-2 right-2"
            :disabled="!inputMessage.trim()"
          >
            Send
          </button>
        </div>
      </form>
    </div>
  </div>
</Dialog>

<script>
  import Alpine from "alpinejs";

  const modal = document.getElementById("chat") as HTMLDialogElement | null;
  const chatInput = document.getElementById("chat-input") as HTMLTextAreaElement | null;

  Alpine.data("chatDialog", () => ({
    inputMessage: "",
    resizeTextarea(textarea: HTMLTextAreaElement) {
      textarea.style.height = "auto";
      textarea.style.height = `${Math.min(textarea.scrollHeight, 128)}px`;
    },
    messages: [
      {
        id: 1,
        role: "assistant",
        content: "Hello! How can I help you today?",
      },
      {
        id: 2,
        role: "user",
        content: "What is Astro?",
      },
      {
        id: 3,
        role: "assistant",
        content: "Astro is a modern web framework for building fast, content-focused websites. It allows you to use your favorite UI components and outputs zero JavaScript by default, resulting in faster page loads.",
      },
      {
        id: 4,
        role: "user",
        content: "That sounds interesting! Can you tell me more about its features?",
      },
      {
        id: 5,
        role: "assistant",
        content: "Sure! Astro features include:<br/>• Islands architecture for optimal performance<br/>• Support for multiple UI frameworks (React, Vue, Svelte, etc.)<br/>• Built-in content collections<br/>• Optimized images and assets<br/>• TypeScript support out of the box",
      },
    ],
    sendMessage() {
      if (!this.inputMessage.trim()) return;

      // Add user message
      this.messages.push({
        id: this.messages.length + 1,
        role: "user",
        content: this.inputMessage,
      });

      const userMessage = this.inputMessage;
      this.inputMessage = "";
      
      // Reset textarea height
      if (this.$refs.textarea) {
        this.$refs.textarea.style.height = "auto";
      }

      // Scroll to bottom after user message
      this.$nextTick(() => {
        if (this.$refs.messagesContainer) {
          this.$refs.messagesContainer.scrollTop = this.$refs.messagesContainer.scrollHeight;
        }
      });

      // Simulate LLM response (placeholder)
      setTimeout(() => {
        this.messages.push({
          id: this.messages.length + 1,
          role: "assistant",
          content: `I received your message: "${userMessage}". This is a placeholder response. In a real implementation, this would connect to an LLM API.`,
        });

        // Scroll to bottom after LLM response
        this.$nextTick(() => {
          if (this.$refs.messagesContainer) {
            this.$refs.messagesContainer.scrollTop = this.$refs.messagesContainer.scrollHeight;
          }
        });
      }, 500);
    },
    init() {
      // Scroll to bottom on init
      this.$nextTick(() => {
        if (this.$refs.messagesContainer) {
          this.$refs.messagesContainer.scrollTop = this.$refs.messagesContainer.scrollHeight;
        }
      });
    },
  }));

  document.addEventListener("keydown", (event) => {
    if (event.ctrlKey && event.key === "a") {
      event.preventDefault();
      modal?.showModal();
      chatInput?.focus();
    }
  });
</script>

