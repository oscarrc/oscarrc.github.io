---
import Dialog from "./Dialog.astro";
import Icon from "./Icon.astro";
---

<Dialog id="search">
  <div class="flex flex-col gap-4" x-data="searchDialog">
    <label class="input w-full">
      <Icon name="search" class="text-xl" />
      <input
        type="search"
        class="grow w-full"
        placeholder="Search"
        id="search-input"
        x-model="query"
        autocomplete="off"
      />
    </label>
    <div id="search-results" class="h-96 overflow-y-auto">
      <template x-if="idle">
        <div class="flex items-center justify-center h-full">
          <p class="text-lg text-neutral text-sm">Start typing to search...</p>
        </div>
      </template>

      <template x-if="loading">
        <div class="flex items-center justify-center h-full">
          <p class="text-lg text-neutral text-sm flex items-center gap-2">
            <span class="loading loading-spinner loading-xs"></span> Searching...
          </p>
        </div>
      </template>

      <template x-if="error">
        <div class="flex items-center justify-center h-full">
          <p class="text-lg text-error text-sm" x-text="error"></p>
        </div>
      </template>

      <template x-if="!idle && !loading && results.length === 0">
        <div class="flex items-center justify-center h-full">
          <p class="text-lg text-neutral text-sm">No results found</p>
        </div>
      </template>

      <template x-if="!idle && !loading && results.length > 0">
        <div class="flex flex-col px-2 gap-2">
          <template x-for="result in results" :key="result.url">
            <a
              :href="result.url"
              class="w-full rounded-box hover:bg-base-200 flex flex-col p-3 transition-colors cursor-pointer group"
            >
              <!-- Path/Breadcrumb -->
              <div class="text-xs text-neutral mb-0.5 line-clamp-1">
                <span x-text="result.url"></span>
              </div>
              <!-- Title -->
              <h3
                class="text-sm font-semibold text-base-content mb-0.5 line-clamp-1 group-hover:text-primary transition-colors"
              >
                <span x-html="result.meta?.title || result.url"></span>
              </h3>
              <!-- Excerpt -->
              <p
                class="text-xs text-accent line-clamp-2 leading-snug"
                x-html="result.excerpt || ''"
              >
              </p>
            </a>
          </template>
        </div>
      </template>
    </div>
  </div>
</Dialog>

<script type="module">
  try {
    const pagefind = await import("/pagefind/pagefind.js");
    window.pagefind = pagefind;
    pagefind.init();
    window.dispatchEvent(new CustomEvent("pagefindReady"));
  } catch (error) {
    console.error("Failed to load Pagefind:", error);
    window.dispatchEvent(new CustomEvent("pagefindError", { detail: error }));
  }
</script>

<script>
  import { getPagefind } from "@/utils/pagefind";
  import Alpine from "alpinejs";

  const modal = document.getElementById("search") as HTMLDialogElement | null;
  const searchInput = document.getElementById(
    "search-input"
  ) as HTMLInputElement | null;

  Alpine.data("searchDialog", () => ({
    loading: false,
    idle: true,
    error: null as string | null,
    query: "",
    pagefind: null as {
      init: () => void;
      debouncedSearch: (query: string) => Promise<any>;
    } | null,
    results: [] as any[],
    async init() {
      this.pagefind = await getPagefind();
      this.$watch("query", (value) => {
        if (!value.trim()) {
          this.idle = true;
          this.results = [];
          return;
        } else {
          this.idle = false;
          this.onSearch();
        }
      });
    },
    async onSearch() {
      if (!this.pagefind) return;

      this.loading = true;

      try {
        const search = await this.pagefind.debouncedSearch(this.query);
        if (search === null) {
          this.loading = false;
          return;
        }
        this.results = await Promise.all(
          search.results.map(async (result: any) => await result.data())
        );
      } catch (error) {
        this.error = "An error occurred during the search.";
      } finally {
        this.loading = false;
      }
    },
  }));

  document.addEventListener("keydown", (event) => {
    if (event.ctrlKey && event.key === "k") {
      event.preventDefault();
      modal?.showModal();
      searchInput?.focus();
      // @ts-ignore
      Alpine.store("searchDialog").pagefind?.init();
    }
  });
</script>
