---
import Dialog from "./Dialog.astro";
import Icon from "./Icon.astro";
---

<Dialog id="search">
  <div class="flex flex-col gap-4" x-data="searchDialog">
    <label class="input w-full">
      <Icon name="search" class="text-xl" />
      <input
        type="search"
        class="grow w-full"
        placeholder="Search"
        id="search-input"
        x-model="query"
      />
    </label>
    <div id="search-results" class="h-96 overflow-y-auto py-4">
      <template x-if="idle">
        <div class="flex items-center justify-center h-full">
          <p class="text-lg text-neutral text-sm">Start typing to search...</p>
        </div>
      </template>

      <template x-if="loading">
        <div class="flex items-center justify-center h-full">
          <p class="text-lg text-neutral text-sm flex items-center gap-2">
            <span class="loading loading-spinner loading-xs"></span> Searching...
          </p>
        </div>
      </template>

      <template x-if="!idle && !loading && results.length === 0">
        <div class="flex items-center justify-center h-full">
          <p class="text-lg text-neutral text-sm">No results found</p>
        </div>
      </template>

      <template x-if="!idle && !loading && results.length > 0">
        <div class="flex flex-col gap-2 px-2">
          <template x-for="result in results" :key="result.url">
            <article class="w-full flex flex-col gap-2 p-2 pb-4 border-b last:border-b-0 hover:bg-base-200/50 transition-colors cursor-pointer">
              <div class="flex flex-col gap-1">
                <h3 class="text-xl font-semibold">
                  <a
                    :href="result.url"
                    class="hover:text-primary transition-colors"
                  >
                    <span x-html="result.meta?.title || result.url"></span>
                  </a>
                </h3>
                <div class="flex items-center gap-2 text-neutral text-xs">
                  <span class="text-base-content/60" x-text="result.url"></span>
                </div>
              </div>
              <p
                class="text-accent text-sm line-clamp-3 leading-relaxed"
                x-html="result.excerpt || ''"
              >
              </p>
              <div class="flex gap-2 mt-1">
                <a
                  :href="result.url"
                  class="btn btn-outline btn-sm"
                >
                  Read More &#xf013e;
                </a>
              </div>
            </article>
          </template>
        </div>
      </template>
    </div>
  </div>
</Dialog>

<script type="module">
  try {
    const pagefind = await import("/pagefind/pagefind.js");
    window.pagefind = pagefind;
    pagefind.init();
    window.dispatchEvent(new CustomEvent("pagefindReady"));
  } catch (error) {
    console.error("Failed to load Pagefind:", error);
    window.dispatchEvent(new CustomEvent("pagefindError", { detail: error }));
  }
</script>

<script>
  import { getPagefind } from "@/utils/pagefind";
  import Alpine from "alpinejs";

  const modal = document.getElementById("search") as HTMLDialogElement | null;
  const searchInput = document.getElementById(
    "search-input"
  ) as HTMLInputElement | null;

  Alpine.data("searchDialog", () => ({
    loading: false,
    idle: true,
    query: "",
    pagefind: null as {
      init: () => void;
      debouncedSearch: (query: string) => Promise<any>;
    } | null,
    results: [] as any[],
    async init() {
      this.pagefind = await getPagefind();
      this.$watch("query", (value) => {
        if (!value.trim()) {
          this.idle = true;
          this.results = [];
          return;
        } else {
          this.onSearch();
        }
      });
    },
    async onSearch() {
      if (!this.pagefind) return;

      this.idle = false;
      this.loading = true;
      const search = await this.pagefind.debouncedSearch(this.query);
      if (search === null) {
        this.loading = false;
        return;
      }
      this.results = await Promise.all(
        search.results.map(async (result: any) => await result.data())
      );
      console.log(this.results);
      this.loading = false;
    },
  }));

  document.addEventListener("keydown", (event) => {
    if (event.ctrlKey && event.key === "k") {
      event.preventDefault();
      modal?.showModal();
      searchInput?.focus();
      // @ts-ignore
      Alpine.store("searchDialog").pagefind?.init();
    }
  });
</script>
