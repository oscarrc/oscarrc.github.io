---
import TagCard from "@/components/TagCard.astro";
import Pagination from "@/components/Pagination.astro";
import Section from "@/components/Section.astro";
import Layout from "@/layouts/Layout.astro";
import siteConfig from "@/site.config";
import {
  getSortedTags,
  getSortedCollectionByTag,
} from "@/utils/collections";
import { slug } from "github-slugger";
import type { GetStaticPaths } from "astro";

export const getStaticPaths = (async ({ paginate }) => {
  // Get all tags from both collections
  const allTags = await getSortedTags(["posts", "projects"]);
  const uniqueTags = Array.from(new Set(allTags.map(([tagName]) => tagName)));

  // Get counts for each tag in both collections
  const tagsWithCounts = await Promise.all(
    uniqueTags.map(async (tagName) => {
      const tagSlug = slug(tagName);
      const postsCount = (await getSortedCollectionByTag("posts", tagSlug)).length;
      const projectsCount = (await getSortedCollectionByTag("projects", tagSlug)).length;
      return {
        tagName,
        postsCount,
        projectsCount,
        totalCount: postsCount + projectsCount,
      };
    })
  );

  // Sort by total count (posts + projects) in descending order
  const sortedTags = tagsWithCounts.sort(
    (a, b) => b.totalCount - a.totalCount
  );

  return paginate(sortedTags, { pageSize: siteConfig.pageSize * 2 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const tags = page.data;
---

<Layout title="Tags" description="Browse Oscar R.C.'s projects and posts categorized by tags.">
  <Section title="Content tags" class="flex flex-col gap-8">
    <div class="flex flex-col gap-16 flex-1">
      <div class="flex flex-col gap-8">
        {tags.map((tag) => (
          <TagCard
            tagName={tag.tagName}
            postsCount={tag.postsCount}
            projectsCount={tag.projectsCount}
          />
        ))}
      </div>
      <Pagination
        prevLink={page.url.prev}
        prevText="Newer Tags"
        nextLink={page.url.next}
        nextText="Older Tags"
      />
    </div>
  </Section>
</Layout>

