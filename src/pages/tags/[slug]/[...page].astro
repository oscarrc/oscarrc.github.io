---
import BadgesCard from "@/components/BadgesCard.astro";
import CollectionTabs from "@/components/CollectionTabs.astro";
import Pagination from "@/components/Pagination.astro";
import PostCard from "@/components/PostCard.astro";
import ProjectCard from "@/components/ProjectCard.astro";
import Section from "@/components/Section.astro";
import Layout from "@/layouts/Layout.astro";
import siteConfig from "@/site.config";
import {
  getPostsByTag,
  getProjectsByTag,
  getAllTags,
  getAllSeries,
  getTagData,
} from "@/utils/collections";
import type { GetStaticPaths } from "astro";
import type { CollectionEntry } from "astro:content";

type CombinedEntry =
  | { type: "post"; entry: CollectionEntry<"posts"> }
  | { type: "project"; entry: CollectionEntry<"projects"> };

export const getStaticPaths = (async ({ paginate }) => {
  const paths = [];

  const allTags = await getAllTags();

  for (const tag of allTags) {
    const tagSlug = tag.slug;

    const postsEntries = await getPostsByTag(tagSlug);
    const projectsEntries = await getProjectsByTag(tagSlug);

    const combined: CombinedEntry[] = [
      ...postsEntries.map((entry) => ({
        type: "post" as const,
        entry,
      })),
      ...projectsEntries.map((entry) => ({
        type: "project" as const,
        entry,
      })),
    ].sort((a, b) => {
      const dateA = new Date(
        a.entry.data.updated || a.entry.data.published
      ).getTime();
      const dateB = new Date(
        b.entry.data.updated || b.entry.data.published
      ).getTime();
      return dateB - dateA;
    });

    const paginatedPaths = paginate(combined, {
      pageSize: siteConfig.pageSize,
      params: { slug: tagSlug },
    });

    for (const path of paginatedPaths) {
      paths.push({
        ...path,
        params: {
          ...path.params,
          slug: tagSlug,
        },
      });
    }
  }

  return paths;
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const { slug: tagSlug } = Astro.params;

const entries = page.data as CombinedEntry[];

// Get tag data
const tagData = await getTagData(tagSlug);
const tagName = tagData.name || tagSlug;
const postsCount = tagData.postsCount;
const projectsCount = tagData.projectsCount;

const tags = (await getAllTags()).slice(0, 10);
const series = (await getAllSeries()).slice(0, 10);
---

<Layout
  title={`Content tagged ${tagName}`}
  description={`Browse all ${postsCount + projectsCount} posts and projects tagged with "${tagName}".`}
>
  <Section class="flex flex-col gap-8">
    <CollectionTabs
      tagSlug={tagSlug}
      postsCount={postsCount}
      projectsCount={projectsCount}
    />

    <div class="flex flex-col gap-16">
      <div class="flex flex-col gap-8 2xl:min-w-full">
        {
          entries?.length ? (
            entries.map((item) =>
              item.type === "post" ? (
                <PostCard post={item.entry as CollectionEntry<"posts">} />
              ) : (
                <ProjectCard
                  project={item.entry as CollectionEntry<"projects">}
                />
              )
            )
          ) : (
            <p>{`No content found with the tag "${tagName}".`}</p>
          )
        }
        <Pagination
          prevLink={page.url.prev}
          prevText="Newer Content"
          nextLink={page.url.next}
          nextText="Older Content"
        />
      </div>
    </div>
  </Section>
  <div
    class="2xl:sticky 2xl:top-10 max-w-4xl mx-auto flex flex-col gap-8 2xl:gap-16 p-6"
    slot="right"
  >
    {
      tags?.length > 0 ? (
        <BadgesCard
          badges={tags}
          collection="posts"
          type="tags"
          title="Top tags"
          variant="primary"
        />
      ) : null
    }
    {
      series?.length > 0 ? (
        <BadgesCard
          badges={series}
          type="series"
          title="Top series"
          variant="accent"
        />
      ) : null
    }
  </div>
</Layout>
