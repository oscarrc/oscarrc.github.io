---
import ContentHeader from "@/components/ContentHeader.astro";
import ContentTree from "@/components/ContentTree.astro";
import GiscusComments from "@/components/GiscusComments.astro";
import GithubCard from "@/components/GithubCard.astro";
import Icon from "@/components/Icon.astro";
import Section from "@/components/Section.astro";
import Layout from "@/layouts/Layout.astro";
import siteConfig from "@/site.config";
import { getEntryBySlug } from "@/utils/collections";
import { getCollectionBySlug } from "@/utils/collections";
import type { GetStaticPaths } from "astro";
import { render, type CollectionEntry } from "astro:content";

export const getStaticPaths = (async () => {
  const paths = [];
  const projects = getCollectionBySlug("projects");

  for (const [slug] of projects) {
    paths.push({ params: { slug } });
  }

  return paths;
}) satisfies GetStaticPaths;

const { slug } = Astro.params;

const project = (await getEntryBySlug("projects", slug)) as CollectionEntry<"projects">;

const { Content, headings } = await render(project);
const { collection, data } = project;
const { title, description, cover, published, updated, repo, tags } = data;

const giscusConfig = siteConfig.giscus.projects;
if (!giscusConfig) {
  throw new Error("Giscus configuration is missing in site.config.ts");
}
---

<Layout
  data-pagefind-body
  breadcrumbs={false}
  collapse={{ right: "first", left: "last" }}
>
  <div class="container max-w-4xl mx-auto p-4 space-y-8" slot="top">
    <ContentHeader
      collection={collection}
      title={title}
      description={description}
      cover={cover}
      published={published}
      updated={updated}
      repo={repo}
      tags={tags}
    />
  </div>
  <Section class="flex flex-col gap-16">
    <article data-pagefind-body class="prose prose-invert max-w-none flex-1">
      <Content />
    </article>
    <GiscusComments {...giscusConfig} />
  </Section>
  {
    headings && headings.length > 0 && (
      <div
        slot="right"
        class="2xl:sticky 2xl:top-10 max-w-4xl mx-auto flex flex-col gap-8 p-4"
      >
        {headings && headings.length > 0 && <ContentTree headings={headings} />}
        <div class="flex flex-col gap-4 2xl:gap-8">
          {project.data.repo && <GithubCard repo={project.data.repo} />}
          {!project.data.url || !project.data.active ? (
            <button class="btn btn-disabled max-w-4xl 2xl:max-w-xs mx-auto w-full">
              {project.data.active === false
                ? "Inactive Project"
                : "No Website Available"}
            </button>
          ) : (
            <a
              href={project.data.url}
              rel="noreferrer noopener"
              target="_blank"
              class="btn btn-primary max-w-4xl 2xl:max-w-xs mx-auto w-full"
            >
              Visit Site
              <Icon name="external" class="ml-2 text-xl" />
            </a>
          )}
        </div>
      </div>
    )
  }
</Layout>
