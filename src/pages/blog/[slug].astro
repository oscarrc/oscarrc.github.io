---
import ContentHeader from "@/components/ContentHeader.astro";
import ContentTree from "@/components/ContentTree.astro";
import GiscusComments from "@/components/GiscusComments.astro";
import PostCard from "@/components/PostCard.astro";
import Section from "@/components/Section.astro";
import Subsection from "@/components/Subsection.astro";
import Layout from "@/layouts/Layout.astro";
import siteConfig from "@/site.config";
import {
  getEntryBySlug,
  getNextPostInSeries,
  getSeriesSlug,
} from "@/utils/collections";
import { getCollectionBySlug } from "@/utils/collections";
import { getSimilarEntries } from "@/utils/embeddings";
import type { GetStaticPaths } from "astro";
import { render, type CollectionEntry } from "astro:content";

export const getStaticPaths = (async () => {
  const paths = [];
  const posts = getCollectionBySlug("posts");

  for (const [slug] of posts) {
    paths.push({ params: { slug } });
  }

  return paths;
}) satisfies GetStaticPaths;

const { slug } = Astro.params;

const post = (await getEntryBySlug(slug, "posts")) as CollectionEntry<"posts">;

const { Content, headings, remarkPluginFrontmatter } = await render(post);
const { id, collection, data } = post;
const { title, description, cover, published, updated, series, author, tags } = data;
const { minutesRead } = remarkPluginFrontmatter;

const seriesSlug = series ? getSeriesSlug(series) : null;
const nextPost = seriesSlug ? getNextPostInSeries(seriesSlug, id) : null;

const giscusConfig = siteConfig.giscus.blog;
if (!giscusConfig) {
  throw new Error("Giscus configuration is missing in site.config.ts");
}

const similar = await getSimilarEntries(slug, 2, "posts");
const similarEntries = await Promise.all(similar.map((entry) => getEntryBySlug(entry.slug, "posts")));
---

<Layout
  data-pagefind-body
  breadcrumbs={false}
  collapse={{ right: "first", left: "last" }}
>
  <div class="container max-w-4xl mx-auto p-4 space-y-8" slot="top">
    <ContentHeader
      collection={collection}
      title={title}
      description={description}
      cover={cover}
      published={published}
      updated={updated}
      series={series}
      author={author}
      tags={tags}
      readingTime={minutesRead}
    />
  </div>
  <Section class="flex flex-col gap-16">
    <article data-pagefind-body class="prose prose-invert max-w-none flex-1">
      <Content />
    </article>
    { nextPost ? (
      <Subsection title="More from this series">
        <PostCard post={nextPost} />
      </Subsection>
    ) : null }
    { similarEntries.length > 0 ? (
      <Subsection title="Similar posts">
        { similarEntries.map((entry) => (
          <PostCard post={entry as CollectionEntry<"posts">} />
        )) }
      </Subsection>
    ) : null }
    <Subsection title="Comments">
      <GiscusComments {...giscusConfig} />
    </Subsection>
  </Section>
  {
    headings && headings.length > 0 && (
      <aside
        slot="right"
        class="2xl:sticky 2xl:top-10 max-w-4xl mx-auto flex flex-col gap-8 p-4"
      >
        {headings && headings.length > 0 && <ContentTree headings={headings} />}
      </aside>
    )
  }
</Layout>
