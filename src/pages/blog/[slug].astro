---
import ContentHeader from "@/components/ContentHeader.astro";
import ContentTree from "@/components/ContentTree.astro";
import Section from "@/components/Section.astro";
import Layout from "@/layouts/Layout.astro";
import { getEntryBySlug } from "@/utils/collections";
import { getCollectionBySlug } from "@/utils/collections";
import type { GetStaticPaths } from "astro";
import { render, type CollectionEntry } from "astro:content";

export const getStaticPaths = (async () => {
  const paths = [];
  const posts = getCollectionBySlug("posts");

  for (const [slug] of posts) {
    paths.push({ params: { slug } });
  }

  return paths;
}) satisfies GetStaticPaths;

const { slug } = Astro.params;
const post = (await getEntryBySlug("posts", slug)) as CollectionEntry<"posts">;
const { Content, headings, remarkPluginFrontmatter } = await render(post);
const { minutesRead } = remarkPluginFrontmatter;
---

<Layout
  data-pagefind-body
  breadcrumbs={false}
  collapse={{ right: "first", left: "last" }}
>
  <div class="container max-w-4xl mx-auto p-4 space-y-8" slot="top">
    <ContentHeader
      collection={post.collection}
      title={post.data.title}
      description={post.data.description}
      cover={post.data.cover}
      published={post.data.published}
      updated={post.data?.updated}
      series={post.data.series}
      author={post.data.author}
      tags={post.data.tags}
      readingTime={minutesRead}
    />
  </div>
  <Section class="flex flex-col gap-16">
    <article data-pagefind-body class="prose prose-invert max-w-none flex-1">
      <Content />
    </article>
  </Section>
  {
    headings && headings.length > 0 && (
      <aside
        slot="right"
        class="2xl:sticky 2xl:top-10 max-w-4xl mx-auto flex flex-col gap-16 p-4"
      >
        <ContentTree headings={headings} />
      </aside>
    )
  }
</Layout>
